<!DOCTYPE html>
<html lang="en">
<head>
	<title>Particle Designer</title>
	<style>
		#canvas {
			float: left;
		}
		#uiRoot {
			float: left;
		}
	</style>
</head>
<body>
	<canvas id="canvas" width="400" height="400"></canvas>
	<div id="uiRoot"></div>

	<script type="text/javascript" src="javascripts/third/underscore-min.js"></script>
	<script type="text/javascript" src="javascripts/third/stats.min.js"></script>
	<script type="text/javascript" src="javascripts/third/uki.js"></script>

	<script type="text/javascript" src="javascripts/particlesystem/util.js"></script>
	<script type="text/javascript" src="javascripts/particlesystem/Particle.js"></script>
	<script type="text/javascript" src="javascripts/particlesystem/Emitter.js"></script>
	<script type="text/javascript" src="javascripts/particlesystem/Renderer.js"></script>
	<script type="text/javascript">

	this.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || window.oRequestAnimationFrame || function(callback) {
		window.setTimeout(callback, 1 / 60 * 1000);
	};

		function getStats() {
			var stats = new Stats();
			stats.setMode(0); // 0: fps, 1: ms
	
			// Align top-left
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.right = '0px';
			stats.domElement.style.top = '0px';

			document.body.appendChild( stats.domElement );
			return stats;
		}

		var stats = getStats();

		var lastTimestamp = 0;
		var texture = new Image();
		texture.src = 'particle.png';
		var particleSystem;
		this.ps = particleSystem = new pjs.Emitter({
			totalParticles: 300,
			emissionRate: 50,
			pos: { x: 200, y: 200 },
			angle: 0,
			angleVar: 360,
			speed: 20,
			speedVar: 10,
			life: 7,
			lifeVar: 4,
			radialAccel: -20,
			radialAccelVar: 0,
			tangentialAccel: 15,
			tangentialAccelVar: 0,
			radius: 10,
			radiusVar: 4,
			startScale: 1,
			endScale: 0,
			texture: texture,
			startColor: [1, 0.5, 0, 0.8],
			endColor: [0, 0, 0, 0],
			active: true,
			duration: Infinity
		});

		var context = document.getElementById('canvas').getContext('2d');
		function draw(timestamp) {
			stats.begin();
			var delta = timestamp - (lastTimestamp || timestamp);
			lastTimestamp = timestamp;

			delta /= 1000;
			particleSystem.update(delta);

			context.fillStyle = 'black';
			context.fillRect(0, 0, context.canvas.width, context.canvas.height);

			pjs.Renderer.render(context, particleSystem.particles);
			
			stats.end();
			requestAnimationFrame(draw);
		}

		draw(new Date().getTime());

		function setupUki() {
			var overlay = [
				'{', 
				'"startColor": [1, 0.5, 0.1, 1],',
				'"posVar": { "x": 20, "y": 0 },',
				'"startColorVar": [0.2, 0.1, 0, 0.2],',
				'"endColor" : [0, 0, 0, 0.3],',
				'"endColorVar": [0, 0.1, 0.05, 0.05],',
				'"tangentialAccel": 0,',
				'"radialAccel": 0,',
				'"angle": 90,',
				'"angleVar": 15,',
				'"texture": null',
				'}'
			].join('\n');

			uki({ 
						view: 'Box',
						rect: '0 0 400 0',
						childViews: [{ 
								view: 'MultilineTextField', 
								rect: '10 10 400 200', 
								anchor: 'left top right',
								value: overlay
						}, { 
							view: 'Button',
							id: 'overlayButton',
							rect: '10 220 100 24',
							anchor: 'left top right',
							text: 'Overlay' 
						}]
			}).attachTo(document.getElementById('uiRoot'));

			uki('#overlayButton').click(function() {
				particleSystem.overlay(JSON.parse(uki('MultilineTextField').value()));
			});
		}

		setupUki();

	</script>
</body>
</html>

